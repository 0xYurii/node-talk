datasource db {
    provider = "postgresql"
}

generator client {
    provider = "prisma-client-js"
    output   = "../generated/prisma"
}

enum FollowStatus {
    PENDING
    ACCEPTED
    REJECTED
    BLOCKED
}

model User {
    id        Int     @id @default(autoincrement())
    githubId  String? @unique
    username  String  @unique
    email     String  @unique
    password  String
    avatarUrl String  @default("https://zqsqxpnhcgkngfjrldkn.supabase.co/storage/v1/object/public/avatars/photo_2025-08-07_09-45-39.jpg")
    isPrivate Boolean @default(false)

    posts     Post[]
    comments  Comment[]
    likes     Like[]
    createdAt DateTime  @default(now())

    following Follow[] @relation("UserFollowing")
    followers Follow[] @relation("UserFollowers")

    conversations    Conversation[] @relation("ConversationParticipants")
    sentMessages     Message[]      @relation("MessageSender")
}

model Post {
    id        Int       @id @default(autoincrement())
    title     String
    content   String?   @db.Text
    authorId  Int
    user      User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
    comments  Comment[]
    createdAt DateTime  @default(now())
    likes     Like[]
}

model Comment {
    id      Int    @id @default(autoincrement())
    content String @db.Text

    userId Int?
    user   User? @relation(fields: [userId], references: [id], onDelete: SetNull)

    postId    Int
    post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
    createdAt DateTime @default(now())
}

model Like {
    id        Int      @id @default(autoincrement())
    userId    Int
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    postId    Int
    post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
    createdAt DateTime @default(now())

    @@unique([userId, postId])
}

model Follow {
    id          Int          @id @default(autoincrement())
    followerId  Int
    followingId Int
    status      FollowStatus @default(PENDING)
    createdAt   DateTime     @default(now())
    updatedAt   DateTime     @updatedAt

    follower  User @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)
    following User @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)

    @@unique([followerId, followingId])
    @@index([followingId])
    @@index([followerId])
}

model Conversation{
    id          Int          @id @default(autoincrement())
    createdAt   DateTime     @default(now())
    updatedAt   DateTime     @updatedAt

    //Many to Many
    participants User[] @relation("ConversationParticipants")

    messages Message[]

}

model Message {
  id             Int          @id @default(autoincrement())
  content        String       @db.Text
  createdAt      DateTime     @default(now())

  // Who sent it?
  senderId       Int
  sender         User         @relation("MessageSender", fields: [senderId], references: [id])

  // Which conversation?
  conversationId Int
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Has it been read?
  isRead         Boolean      @default(false)
}
